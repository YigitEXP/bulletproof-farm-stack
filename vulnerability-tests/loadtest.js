import http from 'k6/http';
import { check, sleep } from 'k6';
// 1. ADIM: exec kütüphanesini içeri alıyoruz
import exec from 'k6/execution'; 

export const options = {
    vus: 10,
    duration: '5s',
};

export default function () {
    const payload = JSON.stringify({
        username: 'test_saldirgani',
        password: 'yanlissifre123',
    });

    const params = {
        headers: { 'Content-Type': 'application/json' },
    };

    // Nginx (Ön Kapı) üzerinden FastAPI'ye saldırı
    const res = http.post('http://host.docker.internal/api/login', payload, params);

    // 2. ADIM: Beklediğimiz durum kodlarını bir değişkene atıyoruz
    const isExpected = res.status === 200 || res.status === 401 || res.status === 429;

    // 3. ADIM: EĞER kod beklediğimiz gibi değilse VE ilk 5 denemedeysek logla
    if (!isExpected && exec.scenario.iterationInTest < 5) {
        console.log(`[Bot İterasyonu: ${exec.scenario.iterationInTest}] Öngörülemeyen Durum Kodu: ${res.status} | Yanıt: ${res.body}`);
    }

    // Kontrol Noktaları
    check(res, {
        'Kalkan Delindi (200 OK)': (r) => r.status === 200,
        'Yetki Reddedildi (401)': (r) => r.status === 401,
        'Redis Kalkanı Devrede (429)': (r) => r.status === 429,
    });

    sleep(0.1);
}